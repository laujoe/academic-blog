{{- if not ($.Page.Scratch.Get "embed-pdf-count") -}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<style>
  /* === PDF é˜…è¯»å™¨æ ·å¼ (é€‚é… Congo) === */
  .pdf-viewer-card {
    /* --- æ ¸å¿ƒå˜é‡å®šä¹‰ --- */
    --pdf-bg-card: #ffffff;
    --pdf-bg-toolbar: rgba(255, 255, 255, 0.95);
    --pdf-bg-viewport: #f5f5f7;
    --pdf-text-title: #333;
    --pdf-text-btn: #555;
    --pdf-text-btn-hover: #000;
    --pdf-border: rgba(0,0,0,0.08);
    --pdf-shadow-card: 0 12px 40px rgba(0,0,0,0.08), 0 0 0 1px rgba(0,0,0,0.02);
    --pdf-shadow-canvas: 0 4px 15px rgba(0,0,0,0.08);
    --pdf-loading-color: #333;

    /* æ‚¬æµ®æ¡æ ·å¼ */
    --pdf-float-bg: rgba(30, 30, 30, 0.85);
    --pdf-float-text: rgba(255,255,255,0.9);
    --pdf-float-hover: rgba(255,255,255,0.2);
    --pdf-float-divider: rgba(255,255,255,0.2);

    position: relative;
    width: 100%;
    margin: 3rem 0;
    background: var(--pdf-bg-card);
    border-radius: 12px;
    box-shadow: var(--pdf-shadow-card);
    border: 1px solid var(--pdf-border);
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
    display: flex;
    flex-direction: column;
    height: 85vh;
    max-height: 900px;
    min-height: 500px;
    transition: all 0.3s ease;
  }

  /* ğŸŒ™ æ·±è‰²æ¨¡å¼é€‚é… (Congo class="dark") */
  html.dark .pdf-viewer-card {
      --pdf-bg-card: #171717; /* Congo neutral-900 */
      --pdf-bg-toolbar: rgba(23, 23, 23, 0.95);
      --pdf-bg-viewport: #0a0a0a;
      --pdf-text-title: #e5e5e5;
      --pdf-text-btn: #a3a3a3;
      --pdf-text-btn-hover: #fff;
      --pdf-border: rgba(255,255,255,0.1);
      --pdf-shadow-card: 0 12px 40px rgba(0,0,0,0.3);
      --pdf-loading-color: #e5e5e5;
  }

  /* === é¡¶éƒ¨å·¥å…·æ  === */
  .pdf-toolbar {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 20px;
    background: var(--pdf-bg-toolbar);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--pdf-border);
    z-index: 10; user-select: none;
  }

  .pdf-window-controls { display: flex; gap: 8px; width: 80px; }
  .win-btn { width: 12px; height: 12px; border-radius: 50%; }
  .win-close { background: #ff5f57; cursor: pointer; transition: transform 0.2s; }
  .win-close:hover { transform: scale(1.1); }
  .win-min { background: #febc2e; }
  .win-max { background: #28c840; }

  .pdf-title { font-size: 14px; color: var(--pdf-text-title); font-weight: 600; opacity: 0.9; }

  .pdf-actions { display: flex; gap: 12px; align-items: center; justify-content: flex-end; width: 80px; }
  .pdf-action-btn {
    color: var(--pdf-text-btn); cursor: pointer; display: flex; align-items: center; justify-content: center;
    width: 32px; height: 32px; border-radius: 8px; transition: all 0.2s;
  }
  .pdf-action-btn:hover { background: rgba(125,125,125,0.1); color: var(--pdf-text-btn-hover); }
  .pdf-action-btn svg { width: 18px; height: 18px; }

  /* === è§†å£ä¸ Canvas === */
  #embed-pdf-viewport {
    flex: 1; background: var(--pdf-bg-viewport); overflow: auto; position: relative;
    display: flex; justify-content: center; padding: 40px; outline: none;
    -webkit-overflow-scrolling: touch; /* iOS æ»šåŠ¨ä¼˜åŒ– */
  }
  
  /* ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šCanvas æ ·å¼ï¼Œç¡®ä¿é«˜æ¸…æ¸²æŸ“æ—¶ä¸è¢«æ’‘å¤§ */
  .pdf-canvas {
    max-width: none !important;
    box-shadow: var(--pdf-shadow-canvas);
    display: none; background-color: #fff;
    /* è¿™é‡Œçš„ width/height ä¼šç”± JS åŠ¨æ€è®¾ç½®ï¼Œä¸è¦å†™æ­» */
  }

  /* === åº•éƒ¨æ‚¬æµ®æ§åˆ¶æ¡ === */
  .pdf-floating-controls {
    position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
    background: var(--pdf-float-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    padding: 8px 14px; border-radius: 50px; display: flex; align-items: center; gap: 10px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.25); z-index: 20; color: var(--pdf-float-text);
    transition: opacity 0.3s, transform 0.3s;
  }
  .ctrl-btn {
    background: transparent; border: none; color: var(--pdf-float-text); cursor: pointer;
    padding: 6px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
    transition: transform 0.2s;
  }
  .ctrl-btn:hover { background: var(--pdf-float-hover); color: #fff; transform: scale(1.1); }
  .ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
  .ctrl-btn svg { width: 18px; height: 18px; }
  .ctrl-divider { width: 1px; height: 18px; background: var(--pdf-float-divider); margin: 0 2px; }
  
  .pdf-page-indicator {
    font-size: 14px; font-weight: 500; font-variant-numeric: tabular-nums;
    padding: 0 8px; cursor: pointer; min-width: 60px; text-align: center;
  }
  .pdf-page-indicator:hover { color: #5ac8fa; }
  .pdf-zoom-level { font-size: 13px; font-variant-numeric: tabular-nums; min-width: 45px; text-align: center; color: rgba(255,255,255,0.8); }

  /* Loading */
  .pdf-loadingWrapper {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    display: flex; flex-direction: column; align-items: center; color: #999;
  }
  .pdf-loading {
    width: 32px; height: 32px; border: 3px solid rgba(125,125,125,0.2);
    border-radius: 50%; border-top-color: var(--pdf-loading-color);
    animation: spin 0.8s ease-in-out infinite; margin-bottom: 12px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* === å…¨å±æ ·å¼ (ä¿ç•™ä½ åŸæœ¬çš„ iOS é€‚é…é€»è¾‘) === */
  .pdf-viewer-card.is-fullscreen {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    width: 100vw !important; height: 100vh !important;
    border-radius: 0; margin: 0; max-height: none; z-index: 99999;
    background: #111; /* å…¨å±æ²‰æµ¸é»‘ */
  }
  .pdf-viewer-card.is-fullscreen #embed-pdf-viewport { background: #1a1a1a; height: 100%; }
  .pdf-viewer-card.is-fullscreen .pdf-toolbar {
    background: rgba(40, 40, 40, 0.9); color: #fff; border-bottom: none;
    padding-top: max(12px, env(safe-area-inset-top)); /* é€‚é…åˆ˜æµ·å± */
  }
  .pdf-viewer-card.is-fullscreen .pdf-title { color: #ddd; }
  .pdf-viewer-card.is-fullscreen .pdf-action-btn { color: #ccc; }
</style>
{{- end -}}

{{- $.Page.Scratch.Add "embed-pdf-count" 1 -}}
{{ $id := substr (.Get "url" | md5) 0 8 }}
{{ $allowDownload := .Get "allowDownload" | default "true" }}

<div class="pdf-viewer-card" id="pdf-viewer-{{ $id }}" 
     {{ if eq $allowDownload "false" }}oncontextmenu="return false;"{{ end }}>
    
    <div class="pdf-toolbar">
        <div class="pdf-window-controls">
            <div class="win-btn win-close" title="å…³é—­/é€€å‡ºå…¨å±"></div>
            <div class="win-btn win-min"></div>
            <div class="win-btn win-max"></div>
        </div>
        
        <div class="pdf-title">Preview</div>

        <div class="pdf-actions">
            <div class="pdf-action-btn" title="å…¨å±é˜…è¯»" onclick="toggleFullScreen('pdf-viewer-{{ $id }}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
            </div>
            {{ if ne $allowDownload "false" }}
            <a href="{{ .Get "url" }}" class="pdf-action-btn" title="ä¸‹è½½æ–‡ä»¶" download>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </a>
            {{ end }}
        </div>
    </div>

    <div id="embed-pdf-viewport" class="pdf-viewport-{{ $id }}" tabindex="0">
        <div class="pdf-loadingWrapper" id="pdf-loadingWrapper-{{ $id }}">
            <div class="pdf-loading"></div>
            <span style="font-size:12px; font-weight:500;">LOADING</span>
        </div>
        <canvas class="pdf-canvas" id="pdf-canvas-{{ $id }}"></canvas>
    </div>

    <div class="pdf-floating-controls" id="pdf-controls-{{ $id }}">
        <button class="ctrl-btn" id="pdf-prev-{{ $id }}" title="ä¸Šä¸€é¡µ (â†)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
        
        <span class="pdf-page-indicator" title="ç‚¹å‡»è·³è½¬é¡µç " id="pdf-page-indicator-{{ $id }}">
            <span id="pdf-pagenum-{{ $id }}">1</span> / <span id="pdf-pagecount-{{ $id }}">--</span>
        </span>
        
        <button class="ctrl-btn" id="pdf-next-{{ $id }}" title="ä¸‹ä¸€é¡µ (â†’)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>

        <div class="ctrl-divider"></div>

        <button class="ctrl-btn" id="pdf-fit-width-{{ $id }}" title="è‡ªåŠ¨é€‚åº”å®½åº¦ (0)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
        </button>

        <div class="ctrl-divider"></div>

        <button class="ctrl-btn" id="pdf-zoom-out-{{ $id }}" title="ç¼©å° (-)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>
        
        <span class="pdf-zoom-level" id="pdf-zoom-level-{{ $id }}">Auto</span>

        <button class="ctrl-btn" id="pdf-zoom-in-{{ $id }}" title="æ”¾å¤§ (+)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>
    </div>
</div>

<script type="text/javascript">
(function() {
    var url = '{{ .Get "url" }}';
    var hideLoader = "{{ .Get "hideLoader" }}" === "true";
    var selectedPageNum = parseInt("{{ .Get "renderPageNum" }}") || 1;
    var idSuffix = "{{ $id }}";

    // æ ¸å¿ƒä¿®æ”¹ 1ï¼šè·å–è®¾å¤‡åƒç´ æ¯” (Retinaå±é€šå¸¸ä¸º 2)
    // è¿™æ˜¯è§£å†³æ¨¡ç³Šçš„å…³é”®
    var outputScale = window.devicePixelRatio || 1;

    var pdfjsLib = window['pdfjs-dist/build/pdf'];
    // è‡ªåŠ¨å›é€€æœºåˆ¶ï¼šå¦‚æœå¤´éƒ¨æ²¡å®šä¹‰ workerï¼Œå°è¯•ä½¿ç”¨ CDN
    if (!pdfjsLib.GlobalWorkerOptions.workerSrc)
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    var pdfDoc = null,
        pageNum = selectedPageNum,
        pageRendering = false,
        pageNumPending = null,
        currentScale = 1.0, 
        canvas = document.getElementById('pdf-canvas-' + idSuffix),
        ctx = canvas.getContext('2d'),
        loadingWrapper = document.getElementById('pdf-loadingWrapper-' + idSuffix),
        viewportContainer = document.querySelector('.pdf-viewport-' + idSuffix),
        zoomLevelText = document.getElementById('pdf-zoom-level-' + idSuffix);

    showLoader();

    function renderPage(num) {
      pageRendering = true;
      pdfDoc.getPage(num).then(function(page) {
        
        var viewport = page.getViewport({scale: currentScale});
        
        // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ 2ï¼šé«˜æ¸…æ¸²æŸ“é€»è¾‘
        // æˆ‘ä»¬åˆ›å»ºæ¯”å®é™…å¤§ outputScale å€çš„ç”»å¸ƒ
        canvas.width = Math.floor(viewport.width * outputScale);
        canvas.height = Math.floor(viewport.height * outputScale);

        // ç„¶åç”¨ CSS æŠŠå®ƒç¼©å›åŸæ¥çš„å¤§å°
        canvas.style.width = Math.floor(viewport.width) + "px";
        canvas.style.height = Math.floor(viewport.height) + "px";

        // å‘Šè¯‰ PDF.js æŒ‰ç…§æ”¾å¤§çš„æ¯”ä¾‹æ¸²æŸ“
        var transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;

        var renderContext = {
          canvasContext: ctx,
          viewport: viewport,
          transform: transform // ä¼ å…¥å˜æ¢çŸ©é˜µ
        };
        
        var renderTask = page.render(renderContext);

        renderTask.promise.then(function() {
          pageRendering = false;
          showContent();
          updateButtons();
          updateZoomDisplay();
          if (pageNumPending !== null) {
            renderPage(pageNumPending);
            pageNumPending = null;
          }
        });
      });
      document.getElementById('pdf-pagenum-' + idSuffix).textContent = num;
    }

    function showContent() {
      loadingWrapper.style.display = 'none';
      canvas.style.display = 'block';
    }
    function showLoader() {
      if(hideLoader) return;
      loadingWrapper.style.display = 'flex';
      canvas.style.display = 'none';
    }
    function queueRenderPage(num) {
      if (pageRendering) { pageNumPending = num; } else { renderPage(num); }
    }
    function updateButtons() {
        document.getElementById('pdf-prev-' + idSuffix).disabled = pageNum <= 1;
        document.getElementById('pdf-next-' + idSuffix).disabled = (pdfDoc && pageNum >= pdfDoc.numPages);
    }
    function updateZoomDisplay() {
        var percentage = Math.round(currentScale * 100);
        zoomLevelText.textContent = percentage + "%";
    }

    // è‡ªåŠ¨é€‚åº”å®½åº¦é€»è¾‘
    function fitToWidth() {
        if (!pdfDoc) return;
        pdfDoc.getPage(pageNum).then(function(page) {
            var containerW = viewportContainer.clientWidth;
            var unscaledViewport = page.getViewport({scale: 1});
            if (containerW > 0) {
                // å‡å» padding
                currentScale = (containerW - 80) / unscaledViewport.width;
                if (currentScale < 0.5) currentScale = 0.5;
                queueRenderPage(pageNum);
            }
        });
    }

    function zoomIn() { currentScale *= 1.2; queueRenderPage(pageNum); }
    function zoomOut() { if (currentScale > 0.4) { currentScale /= 1.2; queueRenderPage(pageNum); } }

    // === æ¢å¤ï¼šæ‰€æœ‰äº‹ä»¶ç›‘å¬ ===
    document.getElementById('pdf-zoom-in-' + idSuffix).addEventListener('click', zoomIn);
    document.getElementById('pdf-zoom-out-' + idSuffix).addEventListener('click', zoomOut);
    document.getElementById('pdf-fit-width-' + idSuffix).addEventListener('click', fitToWidth);

    document.getElementById('pdf-prev-' + idSuffix).addEventListener('click', function() {
        if (pageNum <= 1) return;
        pageNum--; queueRenderPage(pageNum);
    });
    document.getElementById('pdf-next-' + idSuffix).addEventListener('click', function() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++; queueRenderPage(pageNum);
    });
    
    // æ¢å¤ï¼šç‚¹å‡»çº¢ç‚¹é€€å‡ºå…¨å±
    var closeBtn = document.querySelector('#pdf-viewer-' + idSuffix + ' .win-close');
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            if (document.getElementById('pdf-viewer-' + idSuffix).classList.contains('is-fullscreen')) {
                exitFullScreen('pdf-viewer-' + idSuffix);
            }
        });
    }

    // æ¢å¤ï¼šç‚¹å‡»é¡µç è·³è½¬åŠŸèƒ½
    document.getElementById('pdf-page-indicator-' + idSuffix).addEventListener('click', function() {
        var newPage = prompt("è·³è½¬åˆ°é¡µç  (1-" + pdfDoc.numPages + "):", pageNum);
        newPage = parseInt(newPage);
        if (newPage && newPage >= 1 && newPage <= pdfDoc.numPages) {
            pageNum = newPage;
            queueRenderPage(pageNum);
        }
    });

    // æ¢å¤ï¼šé”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        var card = document.getElementById('pdf-viewer-' + idSuffix);
        var viewport = document.querySelector('.pdf-viewport-' + idSuffix);
        // åªæœ‰å½“é¼ æ ‡æ‚¬åœåœ¨å¡ç‰‡ä¸Šï¼Œæˆ–è€…å¡ç‰‡å¤„äºå…¨å±æ—¶æ‰å“åº”å¿«æ·é”®
        var isActive = document.fullscreenElement === card || 
                       card.classList.contains('is-fullscreen') || 
                       card.matches(':hover');

        if (isActive) {
            if (e.key === "ArrowLeft") {
                if (pageNum > 1) { pageNum--; queueRenderPage(pageNum); }
            } else if (e.key === "ArrowRight") {
                if (pageNum < pdfDoc.numPages) { pageNum++; queueRenderPage(pageNum); }
            } else if (e.key === "+" || e.key === "=") { zoomIn(); }
            else if (e.key === "-") { zoomOut(); }
            else if (e.key === "0") { fitToWidth(); }
            else if (e.key === "Escape") { exitFullScreen('pdf-viewer-' + idSuffix); }
        }
    });

    // æ¢å¤ï¼šå…¨å±çŠ¶æ€ç›‘å¬
    function handleFullScreenChange() {
        var card = document.getElementById('pdf-viewer-' + idSuffix);
        var isSystemFullscreen = document.fullscreenElement || document.webkitFullscreenElement;
        // å¦‚æœé€€å‡ºäº†ç³»ç»Ÿå…¨å±ï¼Œç§»é™¤ class (iOS é™¤å¤–)
        if (!isSystemFullscreen && card.classList.contains('is-fullscreen')) {
            if (!isIOS()) { card.classList.remove('is-fullscreen'); }
        }
    }
    document.addEventListener('fullscreenchange', handleFullScreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullScreenChange);

    // åˆå§‹åŒ–
    pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
      pdfDoc = pdfDoc_;
      document.getElementById('pdf-pagecount-' + idSuffix).textContent = pdfDoc.numPages;
      fitToWidth();
    });
})();

// è¾…åŠ©å‡½æ•°
function isIOS() {
  return /iPad|iPhone|iPod/.test(navigator.platform) || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
}

// æ¢å¤ï¼šå…¨å±é€»è¾‘ (å¸¦ iOS å…¼å®¹)
window.toggleFullScreen = function(elementId) {
    var element = document.getElementById(elementId);
    if (element.classList.contains('is-fullscreen')) { exitFullScreen(elementId); } 
    else { enterFullScreen(elementId); }
}

window.enterFullScreen = function(elementId) {
    var element = document.getElementById(elementId);
    element.classList.add('is-fullscreen');
    if (!isIOS()) {
        if(element.requestFullscreen) { element.requestFullscreen().catch(err => console.log(err)); } 
        else if(element.webkitRequestFullscreen) { element.webkitRequestFullscreen(); }
    }
}

window.exitFullScreen = function(elementId) {
    var element = document.getElementById(elementId);
    element.classList.remove('is-fullscreen');
    if (document.fullscreenElement || document.webkitFullscreenElement) {
        if(document.exitFullscreen) { document.exitFullscreen(); }
        else if(document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
    }
}
</script>